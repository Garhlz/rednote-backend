name: Deploy to Server (CI/CD)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  JAR_NAME: rednote_backend.jar

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------
      # 1. å‡†å¤‡å·¥ä½œ
      # -----------------------------------------------------------------
      - name: ğŸ“¥ æ‹‰å–ä»£ç  (Checkout)
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ã€ç§»é™¤ã€‘ä¸å†éœ€è¦è®¾ç½® Go ç¯å¢ƒï¼Œå› ä¸ºéƒ½åœ¨ Dockerfile é‡Œå®Œæˆäº†
      # - name: ğŸ¹ è®¾ç½® Go ç¯å¢ƒ ...

      # -----------------------------------------------------------------
      # 2. æ„å»ºé˜¶æ®µ (Java + Docker Image)
      # -----------------------------------------------------------------
      - name: ğŸ“¦ Maven æ„å»º Java JAR
        run: ./mvnw clean package -DskipTests

      # ã€ç§»é™¤ã€‘ä¸å†éœ€è¦æ‰‹åŠ¨ç¼–è¯‘ Go Binary
      # - name: ğŸ”¨ ç¼–è¯‘ Go Binary ...

      - name: ğŸ³ æ„å»ºå¹¶æ‰“åŒ… Docker é•œåƒ
        run: |
          cd sync-sidecar
          echo "Building Docker image (Multi-stage)..."
          
          # Docker ä¼šè‡ªåŠ¨æ‹‰å– golang:1.25 é•œåƒè¿›è¡Œç¼–è¯‘
          docker build --platform linux/amd64 -t afternoon-sync-sidecar:latest .
          
          echo "Saving Docker image to tar.gz..."
          docker save afternoon-sync-sidecar:latest | gzip > sidecar-image.tar.gz
          
          ls -lh sidecar-image.tar.gz

      # -----------------------------------------------------------------
      # 3. é…ç½® SSH ç¯å¢ƒ
      # -----------------------------------------------------------------
      - name: ğŸ”‘ é…ç½® SSH ç§é’¥
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ›¡ï¸ æ·»åŠ æœåŠ¡å™¨æŒ‡çº¹
        run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # -----------------------------------------------------------------
      # 4. åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨
      # -----------------------------------------------------------------
      - name: ğŸ“¤ åŒæ­¥æ–‡ä»¶ (Rsync)
        run: |
          # 1. åŒæ­¥é…ç½®æ–‡ä»¶
          echo ">> åŒæ­¥é…ç½®..."
          rsync -rlvz --omit-dir-times --no-perms --no-owner --no-group \
            --exclude 'target' \
            --exclude 'sync-sidecar' \
            --exclude '.git' \
            --exclude '.idea' \
            --exclude 'logs' \
            --exclude 'pg_data' \
            --exclude 'mongo_data' \
            --exclude 'es_data' \
            --exclude 'grafana_data' \
            --exclude 'mvnw' \
            --exclude 'src' \
            --exclude '.env' \
            --exclude 'deploy.sh' \
            . ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.REMOTE_PROJECT_PATH }}/
          
          # 2. åŒæ­¥ Java JAR
          echo ">> åŒæ­¥ Java JAR..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ secrets.REMOTE_PROJECT_PATH }}/target"
          rsync -avz target/${{ env.JAR_NAME }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.REMOTE_PROJECT_PATH }}/target/
          
          # 3. åŒæ­¥ Sidecar é•œåƒåŒ…
          echo ">> åŒæ­¥ Sidecar Image..."
          rsync -avz --progress sync-sidecar/sidecar-image.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.REMOTE_PROJECT_PATH }}/

      # -----------------------------------------------------------------
      # 5. è¿œç¨‹éƒ¨ç½²
      # -----------------------------------------------------------------
      - name: ğŸš€ è¿œç¨‹åŠ è½½é•œåƒå¹¶é‡å¯
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} " \
            cd ${{ secrets.REMOTE_PROJECT_PATH }} && \
          
            # 1. åŠ è½½é•œåƒ
            echo 'ğŸ³ Loading Docker Image...' && \
            docker load -i sidecar-image.tar.gz && \
          
            # 2. é‡å¯æœåŠ¡
            docker compose up -d --build backend sync-sidecar && \
          
            # 3. æ¸…ç†
            rm sidecar-image.tar.gz && \
            docker image prune -f \
          "