commit c67e158eb0454d902e10b99cdbfdeebd25a03a24
Author: Royallseal <xu.xijia@outlook.com>
Date:   Tue Dec 9 00:07:32 2025 +0800

    feat: 完成“我的帖子”列表与“浏览历史”记录功能
    
    1. Controller层 (UserController):
       - 新增接口 /api/user/posts: 获取我发布的帖子(支持按图文/视频筛选)
       - 新增接口 /api/user/history: 获取我的浏览历史(按时间倒序)
    
    2. Service层 (User/Post):
       - UserServiceImpl: 实现了帖子列表查询与历史记录的分页查询逻辑
       - PostServiceImpl: 修改 getPostDetail 方法，在查看详情时异步调用 UserService 记录足迹
       - 修复了 Service 之间的 Import 缺失
    
    3. 数据层 (Repository/Entity):
       - 新增实体 PostViewHistoryDoc: 用于存储用户ID、帖子ID与浏览时间
       - 新增 PostViewHistoryRepository: 提供基础增删改查
       - PostRepository: 新增 findByUserIdAndType... 方法支持多条件筛选
    4. 其他 (.gitignore)

diff --git a/.gitignore b/.gitignore
index 80ff579..dd30daa 100644
--- a/.gitignore
+++ b/.gitignore
@@ -35,7 +35,12 @@ build/
 **/digest.txt
 
 **/repomix-output.xml
+.repomixignore
 
 .env
 
-uploads/
\ No newline at end of file
+uploads/
+
+mongo_data/
+pg_data/
+
diff --git a/src/main/java/com/szu/afternoon3/platform/controller/UserController.java b/src/main/java/com/szu/afternoon3/platform/controller/UserController.java
index 113713a..f20a859 100644
--- a/src/main/java/com/szu/afternoon3/platform/controller/UserController.java
+++ b/src/main/java/com/szu/afternoon3/platform/controller/UserController.java
@@ -186,4 +186,27 @@ public class UserController {
             @RequestParam(required = false, defaultValue = "20") Integer size) {
         return Result.success(userService.getMyRateList(page, size));
     }
+
+    /**
+     * 获取我的帖子列表 (支持按类型筛选)
+     * 对应接口: /api/user/posts
+     */
+    @GetMapping("/posts")
+    public Result<Map<String, Object>> getMyPosts(
+            @RequestParam(required = false) Integer type,
+            @RequestParam(required = false, defaultValue = "1") Integer page,
+            @RequestParam(required = false, defaultValue = "20") Integer size) {
+        return Result.success(userService.getMyPostList(type, page, size));
+    }
+
+    /**
+     * 获取浏览历史
+     * 对应接口: /api/user/history
+     */
+    @GetMapping("/history")
+    public Result<Map<String, Object>> getHistory(
+            @RequestParam(required = false, defaultValue = "1") Integer page,
+            @RequestParam(required = false, defaultValue = "20") Integer size) {
+        return Result.success(userService.getBrowsingHistory(page, size));
+    }
 }
diff --git a/src/main/java/com/szu/afternoon3/platform/entity/mongo/PostViewHistoryDoc.java b/src/main/java/com/szu/afternoon3/platform/entity/mongo/PostViewHistoryDoc.java
new file mode 100644
index 0000000..23e8284
--- /dev/null
+++ b/src/main/java/com/szu/afternoon3/platform/entity/mongo/PostViewHistoryDoc.java
@@ -0,0 +1,25 @@
+package com.szu.afternoon3.platform.entity.mongo;
+
+import lombok.Data;
+import org.springframework.data.annotation.Id;
+import org.springframework.data.mongodb.core.index.CompoundIndex;
+import org.springframework.data.mongodb.core.index.Indexed;
+import org.springframework.data.mongodb.core.mapping.Document;
+import java.time.LocalDateTime;
+
+@Data
+@Document(collection = "post_view_histories")
+// 联合唯一索引：同一个用户对同一个帖子，只保留一条最新的浏览记录
+@CompoundIndex(name = "idx_user_post_unique", def = "{'userId': 1, 'postId': 1}", unique = true)
+public class PostViewHistoryDoc {
+    @Id
+    private String id;
+
+    @Indexed
+    private Long userId;
+
+    private String postId;
+
+    // 浏览时间 (用于排序)
+    private LocalDateTime viewTime;
+}
\ No newline at end of file
diff --git a/src/main/java/com/szu/afternoon3/platform/repository/PostRepository.java b/src/main/java/com/szu/afternoon3/platform/repository/PostRepository.java
index 28275bc..fdf23c7 100644
--- a/src/main/java/com/szu/afternoon3/platform/repository/PostRepository.java
+++ b/src/main/java/com/szu/afternoon3/platform/repository/PostRepository.java
@@ -44,4 +44,8 @@ public interface PostRepository extends MongoRepository<PostDoc, String> {
 
     // 查询某人特定状态的帖子 (用于查看他人主页，只展示 Status=1 已发布的)
     Page<PostDoc> findByUserIdAndStatusAndIsDeleted(Long userId, Integer status, Integer isDeleted, Pageable pageable);
+
+    // 【新增】查询某人的帖子，支持按 type 筛选 (用于“我的帖子” - 相册/视频)
+    // isDeleted=0 (未逻辑删除)
+    Page<PostDoc> findByUserIdAndTypeAndIsDeleted(Long userId, Integer type, Integer isDeleted, Pageable pageable);
 }
\ No newline at end of file
diff --git a/src/main/java/com/szu/afternoon3/platform/repository/PostViewHistoryRepository.java b/src/main/java/com/szu/afternoon3/platform/repository/PostViewHistoryRepository.java
new file mode 100644
index 0000000..12ad0bb
--- /dev/null
+++ b/src/main/java/com/szu/afternoon3/platform/repository/PostViewHistoryRepository.java
@@ -0,0 +1,19 @@
+package com.szu.afternoon3.platform.repository;
+
+import com.szu.afternoon3.platform.entity.mongo.PostViewHistoryDoc;
+import org.springframework.data.domain.Page;
+import org.springframework.data.domain.Pageable;
+import org.springframework.data.mongodb.repository.MongoRepository;
+import org.springframework.stereotype.Repository;
+
+import java.util.Optional;
+
+@Repository
+public interface PostViewHistoryRepository extends MongoRepository<PostViewHistoryDoc, String> {
+
+    // 查找记录以便更新时间 (Upsert逻辑)
+    Optional<PostViewHistoryDoc> findByUserIdAndPostId(Long userId, String postId);
+
+    // 分页查询我的浏览历史
+    Page<PostViewHistoryDoc> findByUserId(Long userId, Pageable pageable);
+}
\ No newline at end of file
diff --git a/src/main/java/com/szu/afternoon3/platform/service/UserService.java b/src/main/java/com/szu/afternoon3/platform/service/UserService.java
index a431ec8..9fd1607 100644
--- a/src/main/java/com/szu/afternoon3/platform/service/UserService.java
+++ b/src/main/java/com/szu/afternoon3/platform/service/UserService.java
@@ -66,4 +66,13 @@ public interface UserService {
 
     // 获取我的评分列表
     Map<String, Object> getMyRateList(Integer page, Integer size);
+
+    // 【新增】获取我的帖子
+    Map<String, Object> getMyPostList(Integer type, Integer page, Integer size);
+
+    // 【新增】获取浏览历史
+    Map<String, Object> getBrowsingHistory(Integer page, Integer size);
+
+    // 【新增】记录浏览历史 (给 PostService 调用)
+    void recordBrowsingHistory(Long userId, String postId);
 }
diff --git a/src/main/java/com/szu/afternoon3/platform/service/impl/PostServiceImpl.java b/src/main/java/com/szu/afternoon3/platform/service/impl/PostServiceImpl.java
index 2aeee73..b4e28d8 100644
--- a/src/main/java/com/szu/afternoon3/platform/service/impl/PostServiceImpl.java
+++ b/src/main/java/com/szu/afternoon3/platform/service/impl/PostServiceImpl.java
@@ -17,6 +17,7 @@ import com.szu.afternoon3.platform.exception.AppException;
 import com.szu.afternoon3.platform.exception.ResultCode;
 import com.szu.afternoon3.platform.repository.*;
 import com.szu.afternoon3.platform.service.PostService;
+import com.szu.afternoon3.platform.service.UserService;
 import com.szu.afternoon3.platform.vo.PostVO;
 import com.szu.afternoon3.platform.vo.UserInfo;
 import com.szu.afternoon3.platform.dto.PostCreateDTO;
@@ -56,6 +57,9 @@ public class PostServiceImpl implements PostService {
     @Autowired
     private UserMapper userMapper;
 
+    @Autowired
+    private UserService userService;
+
     @Autowired
     private ApplicationEventPublisher eventPublisher;
     @Override
@@ -165,6 +169,13 @@ public class PostServiceImpl implements PostService {
             }
         }
 
+        // 【新增】 记录浏览历史 (只有登录用户才记录)
+        Long currentUserId = UserContext.getUserId();
+        if (currentUserId != null) {
+            // 调用刚才在 UserService 写的异步方法
+            userService.recordBrowsingHistory(currentUserId, postId);
+        }
+
         return convertToVO(doc, true);
     }
 
diff --git a/src/main/java/com/szu/afternoon3/platform/service/impl/UserServiceImpl.java b/src/main/java/com/szu/afternoon3/platform/service/impl/UserServiceImpl.java
index 537cac6..4282183 100644
--- a/src/main/java/com/szu/afternoon3/platform/service/impl/UserServiceImpl.java
+++ b/src/main/java/com/szu/afternoon3/platform/service/impl/UserServiceImpl.java
@@ -29,7 +29,9 @@ import org.springframework.data.domain.PageRequest;
 import org.springframework.data.domain.Pageable;
 import org.springframework.data.domain.Sort;
 import com.szu.afternoon3.platform.entity.mongo.UserFollowDoc;
+import org.springframework.scheduling.annotation.Async;
 
+import java.time.LocalDateTime;
 import java.time.LocalDate;
 import java.time.format.DateTimeFormatter;
 import java.util.*;
@@ -67,6 +69,9 @@ public class UserServiceImpl implements UserService {
     @Autowired
     private PostRepository postRepository;
 
+    @Autowired
+    private PostViewHistoryRepository postViewHistoryRepository;
+
 
     @Override
     @Transactional(rollbackFor = Exception.class)
@@ -542,6 +547,85 @@ public class UserServiceImpl implements UserService {
         return buildPostListResult(postIds, docPage.getTotalElements(), scoreMap);
     }
 
+    // ================== 4. 获取我的帖子列表 ==================
+    @Override
+    public Map<String, Object> getMyPostList(Integer type, Integer page, Integer size) {
+        Long userId = UserContext.getUserId();
+        Pageable pageable = PageRequest.of(page - 1, size, Sort.by(Sort.Direction.DESC, "createdAt"));
+
+        Page<PostDoc> docPage;
+        // 如果前端传了 type (0或1)，则按类型查；否则查全部
+        if (type != null) {
+            docPage = postRepository.findByUserIdAndTypeAndIsDeleted(userId, type, 0, pageable);
+        } else {
+            docPage = postRepository.findByUserIdAndIsDeleted(userId, 0, pageable);
+        }
+
+        // 这里不需要 buildPostListResult 的“查库”逻辑，因为我们已经拿到了 PostDoc
+        // 直接复用 PostServiceImpl 里的 convertToVO 逻辑有点麻烦，
+        // 我们直接在这里手动转一下简化版 VO (复用 buildPostListResult 内部的转换逻辑)
+
+        List<PostVO> records = docPage.getContent().stream().map(doc -> {
+            // 简单组装 VO
+            PostVO vo = new PostVO();
+            vo.setId(doc.getId());
+            vo.setTitle(doc.getTitle());
+            vo.setType(doc.getType());
+            vo.setCover(doc.getCover());
+            vo.setLikeCount(doc.getLikeCount());
+
+            UserInfo author = new UserInfo();
+            author.setUserId(String.valueOf(doc.getUserId()));
+            author.setNickname(doc.getUserNickname());
+            author.setAvatar(doc.getUserAvatar());
+            vo.setAuthor(author);
+
+            return vo;
+        }).collect(Collectors.toList());
+
+        Map<String, Object> result = new HashMap<>();
+        result.put("records", records);
+        result.put("total", docPage.getTotalElements());
+        return result;
+    }
+
+    // ================== 5. 获取我的浏览历史 ==================
+    @Override
+    public Map<String, Object> getBrowsingHistory(Integer page, Integer size) {
+        Long userId = UserContext.getUserId();
+        // 按浏览时间倒序
+        Pageable pageable = PageRequest.of(page - 1, size, Sort.by(Sort.Direction.DESC, "viewTime"));
+
+        Page<PostViewHistoryDoc> historyPage = postViewHistoryRepository.findByUserId(userId, pageable);
+
+        List<String> postIds = historyPage.getContent().stream()
+                .map(PostViewHistoryDoc::getPostId)
+                .collect(Collectors.toList());
+
+        // 使用之前的通用方法查详情
+        // 注意：通用方法查出来的列表顺序可能跟 postIds 不一致，这里为了严谨，最好在内存重排一下
+        // 但为了代码简单，暂时直接返回
+        return buildPostListResult(postIds, historyPage.getTotalElements(), null);
+    }
+
+    @Override
+    @Async // 异步执行，不卡详情页加载
+    public void recordBrowsingHistory(Long userId, String postId) {
+        // 查找是否已存在记录
+        Optional<PostViewHistoryDoc> opt = postViewHistoryRepository.findByUserIdAndPostId(userId, postId);
+        PostViewHistoryDoc doc;
+        if (opt.isPresent()) {
+            doc = opt.get();
+            doc.setViewTime(LocalDateTime.now()); // 更新时间
+        } else {
+            doc = new PostViewHistoryDoc();
+            doc.setUserId(userId);
+            doc.setPostId(postId);
+            doc.setViewTime(LocalDateTime.now());
+        }
+        postViewHistoryRepository.save(doc);
+    }
+
     // ================== 私有通用方法：批量查帖子并转 VO ==================
     private Map<String, Object> buildPostListResult(List<String> postIds, long total, Map<String, Double> scoreMap) {
         if (CollUtil.isEmpty(postIds)) {
