server {
    listen 80;
    server_name localhost;

    # =========================================================
    # 0. 根路径重定向 (访问域名直接跳后台，可选)
    # =========================================================
    location = / {
        return 301 /admin;
    }

    # =========================================================
    # 1. Vue 管理后台 (静态文件) - 优先级高
    # ---------------------------------------------------------
    # 只有不包含 "api" 的 /admin 请求才会进这里
    location /admin {
        alias /usr/share/nginx/html/admin;
        index index.html;
        try_files $uri $uri/ /admin/index.html;
    }

    # =========================================================
    # 2. 后台管理专用 API 转发 (核心修正)
    # ---------------------------------------------------------
    # 场景：前端请求 /api/admin/auth/login
    # 动作：去掉 /api 前缀，转发给后端的 /admin/auth/login
    # ---------------------------------------------------------
    location /api/admin/ {
        # 注意：proxy_pass 结尾带斜杠 / 表示“截断路径”
        # Nginx 会把匹配到的 /api/admin/ 替换为 /admin/
        proxy_pass http://backend:8080/admin/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # =========================================================
    # 3. 普通 API 转发
    # ---------------------------------------------------------
    # 场景：前端请求 /api/user/profile
    # 动作：原样转发给后端的 /api/user/profile
    # ---------------------------------------------------------
    location /api/ {
        # 注意：proxy_pass 结尾不带斜杠，表示“完整路径转发”
        proxy_pass http://backend:8080;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # =========================================================
    # 4. Grafana 监控
    # ---------------------------------------------------------
    location /monitor/ {
        proxy_pass http://grafana:3000/; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/live/ {
        proxy_pass http://grafana:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }

    location /mq/ {
        # 1. 关键：把 /mq/ 后面的内容截取出来 ($1)，拼接到 RabbitMQ 的根路径后
        rewrite ^/mq/(.*)$ /$1 break;

        # 2. 转发给 RabbitMQ
        proxy_pass http://rabbitmq:15672;
        
        # 3. 必须设置的 Header，防止 RabbitMQ 页面跳转错乱
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 4. 解决 RabbitMQ 对于 referer 的安全检查 (可选，防 403)
        proxy_set_header Referer "";
    }
}