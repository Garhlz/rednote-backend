server {
    listen 80;
    server_name localhost;

    # -------------------------------------------------------------------
    # 【已移除】resolver 127.0.0.11 valid=30s;
    # 解释：在 Docker Compose 中，Prometheus/Grafana/Backend 的静态服务名
    #       （如 'backend'）会被 Docker 默认 DNS 服务器（127.0.0.11）自动解析。
    #       我们不需要配置 set 变量来强制动态解析。
    # -------------------------------------------------------------------

    # =========================================================
    # 0. 根路径重定向
    # =========================================================
    location = / {
        return 301 /admin;
    }

    # =========================================================
    # 1. Vue 管理后台 (静态文件)
    # ---------------------------------------------------------
    location /admin {
        # 使用 alias 配合子路径，确保文件路径正确
        alias /usr/share/nginx/html/admin;
        index index.html;
        # 路由回退：确保 Vue Router (history 模式) 刷新不 404
        try_files $uri $uri/ /admin/index.html;
    }

    # =========================================================
    # 2. Spring Boot API (最可靠的转发模式)
    # ---------------------------------------------------------
    location /api/ {
        # 【核心修正】不带末尾斜杠，Nginx 会将完整的路径转发到后端
        # Request: /api/auth/login -> Forward: http://backend:8080/api/auth/login
        proxy_pass http://backend:8080;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 确保不出现 HTTP 502/404 错误，并且路径是完整的。
    }

    # =========================================================
    # 3. Grafana 监控面板 (子路径托管)
    # ---------------------------------------------------------
    location /monitor/ {
        # 【建议】去掉末尾的分号（虽然不影响），
        # 且最好要把 Host 头传过去，这对于 Grafana 生成正确的重定向链接至关重要
        proxy_pass http://grafana:3000/;  # 注意这里的末尾斜杠，用于截断 /monitor/ 路径
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 【新增】告诉后端这是 https 还是 http（虽然你是 http，但加上是个好习惯）
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 4. Grafana 的 WebSocket 支持 (Live 图表用)
    # ---------------------------------------------------------
    location /api/live/ {
        # 【修正】使用静态服务名
        proxy_pass http://grafana:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}