name: Deploy to Server (CI/CD)

# è§¦å‘æ¡ä»¶ï¼šå½“ main åˆ†æ”¯æœ‰ä»£ç æ¨é€åˆ° GitHub æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]
  # å…è®¸æ‰‹åŠ¨åœ¨ GitHub ç½‘é¡µä¸Šç‚¹å‡»æŒ‰é’®è§¦å‘
  workflow_dispatch:

# å®šä¹‰å…¨å±€ç¯å¢ƒå˜é‡
env:
  JAR_NAME: rednote_backend.jar # éœ€ä¸ pom.xml ä¸­ç”Ÿæˆçš„åå­—ä¸€è‡´

jobs:
  deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨ GitHub æä¾›çš„æœ€æ–° Ubuntu å®¹å™¨

    steps:
      # -----------------------------------------------------------------
      # 1. å‡†å¤‡å·¥ä½œ
      # -----------------------------------------------------------------
      - name: ğŸ“¥ æ‹‰å–ä»£ç  (Checkout)
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven' # å¼€å¯ Maven ç¼“å­˜ï¼Œä¸‹æ¬¡æ„å»ºä¼šå˜å¿«

      # -----------------------------------------------------------------
      # 2. æœ¬åœ°æ„å»º (å¯¹åº”è„šæœ¬ Step 1)
      # -----------------------------------------------------------------
      - name: ğŸ“¦ Maven æ„å»º (Build)
        run: ./mvnw clean package -DskipTests

      # -----------------------------------------------------------------
      # 3. é…ç½® SSH ç¯å¢ƒ (ä¸º Rsync å’Œ SSH è¿œç¨‹å‘½ä»¤åšå‡†å¤‡)
      # -----------------------------------------------------------------
      - name: ğŸ”‘ é…ç½® SSH ç§é’¥
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ›¡ï¸ æ·»åŠ æœåŠ¡å™¨æŒ‡çº¹ (Known Hosts)
        # é˜²æ­¢ç¬¬ä¸€æ¬¡è¿æ¥æ—¶å¼¹å‡º "Are you sure..." å¯¼è‡´å¡æ­»
        run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # -----------------------------------------------------------------
      # 4. åŒæ­¥æ–‡ä»¶ (å¯¹åº”è„šæœ¬ Step 2)
      # -----------------------------------------------------------------
      - name: ğŸ“¤ åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨ (Rsync)
        run: |
          # 1. åŒæ­¥é…ç½®æ–‡ä»¶ (æ’é™¤é¡¹å®Œå…¨å¤åˆ»ä½ çš„è„šæœ¬)
          echo ">> åŒæ­¥é…ç½®..."
          rsync -rlvz --omit-dir-times --no-perms --no-owner --no-group \
            --exclude 'target' \
            --exclude '.git' \
            --exclude '.idea' \
            --exclude 'logs' \
            --exclude 'pg_data' \
            --exclude 'mongo_data' \
            --exclude 'grafana_data' \
            --exclude 'mvnw' \
            --exclude 'src' \
            --exclude '.env' \
            --exclude 'deploy.sh' \
            . ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.REMOTE_PROJECT_PATH }}/
          
          # 2. ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ secrets.REMOTE_PROJECT_PATH }}/target"
          
          # 3. åŒæ­¥ JAR åŒ…
          echo ">> åŒæ­¥ JAR åŒ…..."
          rsync -avz target/${{ env.JAR_NAME }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.REMOTE_PROJECT_PATH }}/target/

      # -----------------------------------------------------------------
      # 5. è¿œç¨‹é‡å¯ (å¯¹åº”è„šæœ¬ Step 3)
      # -----------------------------------------------------------------
      - name: ğŸš€ è¿œç¨‹é‡å¯ Docker
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} " \
            cd ${{ secrets.REMOTE_PROJECT_PATH }} && \
            docker compose up -d --build backend && \
            docker image prune -f \
          "