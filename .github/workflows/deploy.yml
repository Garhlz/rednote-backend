name: Deploy to Server (CI/CD)

# è§¦å‘æ¡ä»¶ï¼šå½“ main åˆ†æ”¯æœ‰ä»£ç æ¨é€åˆ° GitHub æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]
  # å…è®¸æ‰‹åŠ¨åœ¨ GitHub ç½‘é¡µä¸Šç‚¹å‡»æŒ‰é’®è§¦å‘
  workflow_dispatch:

# å®šä¹‰å…¨å±€ç¯å¢ƒå˜é‡
env:
  JAR_NAME: rednote_backend.jar

jobs:
  deploy:
    runs-on: ubuntu-latest # GitHub çš„ Runner è‡ªå¸¦ Docker ç¯å¢ƒ

    steps:
      # -----------------------------------------------------------------
      # 1. å‡†å¤‡å·¥ä½œ
      # -----------------------------------------------------------------
      - name: ğŸ“¥ æ‹‰å–ä»£ç  (Checkout)
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ¹ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      # -----------------------------------------------------------------
      # 2. æ„å»ºé˜¶æ®µ (Java + Go + Docker Image)
      # -----------------------------------------------------------------
      - name: ğŸ“¦ Maven æ„å»º Java JAR
        run: ./mvnw clean package -DskipTests

      - name: ğŸ”¨ ç¼–è¯‘ Go Binary
        run: |
          cd sync-sidecar
          # ç¼–è¯‘å‡º Linux äºŒè¿›åˆ¶æ–‡ä»¶ (ä¾›ä¸‹ä¸€æ­¥ Docker æ‰“åŒ…ä½¿ç”¨)
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o sync-sidecar-linux .

      - name: ğŸ³ æ„å»ºå¹¶æ‰“åŒ… Docker é•œåƒ
        run: |
          cd sync-sidecar
          echo "Building Docker image..."
          # ä½¿ç”¨æœ¬åœ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºé•œåƒ
          docker build --platform linux/amd64 -t afternoon-sync-sidecar:latest .
          
          echo "Saving Docker image to tar.gz..."
          # å¯¼å‡ºé•œåƒå¹¶å‹ç¼©ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“ä½“ç§¯
          docker save afternoon-sync-sidecar:latest | gzip > sidecar-image.tar.gz
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          ls -lh sidecar-image.tar.gz

      # -----------------------------------------------------------------
      # 3. é…ç½® SSH ç¯å¢ƒ
      # -----------------------------------------------------------------
      - name: ğŸ”‘ é…ç½® SSH ç§é’¥
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ›¡ï¸ æ·»åŠ æœåŠ¡å™¨æŒ‡çº¹
        run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # -----------------------------------------------------------------
      # 4. åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨
      # -----------------------------------------------------------------
      - name: ğŸ“¤ åŒæ­¥æ–‡ä»¶ (Rsync)
        run: |
          # 1. åŒæ­¥é…ç½®æ–‡ä»¶ (æ’é™¤é¡¹ä¸ deploy.sh ä¿æŒä¸€è‡´)
          echo ">> åŒæ­¥é…ç½®..."
          rsync -rlvz --omit-dir-times --no-perms --no-owner --no-group \
            --exclude 'target' \
            --exclude 'sync-sidecar' \
            --exclude '.git' \
            --exclude '.idea' \
            --exclude 'logs' \
            --exclude 'pg_data' \
            --exclude 'mongo_data' \
            --exclude 'es_data' \
            --exclude 'grafana_data' \
            --exclude 'mvnw' \
            --exclude 'src' \
            --exclude '.env' \
            --exclude 'deploy.sh' \
            . ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.REMOTE_PROJECT_PATH }}/
          
          # 2. åŒæ­¥ Java JAR
          echo ">> åŒæ­¥ Java JAR..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ secrets.REMOTE_PROJECT_PATH }}/target"
          rsync -avz target/${{ env.JAR_NAME }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.REMOTE_PROJECT_PATH }}/target/
          
          # 3. åŒæ­¥ Sidecar é•œåƒåŒ… (è¿™é‡Œæ”¹æˆäº†ä¼  tar.gz)
          echo ">> åŒæ­¥ Sidecar Image..."
          rsync -avz --progress sync-sidecar/sidecar-image.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.REMOTE_PROJECT_PATH }}/

      # -----------------------------------------------------------------
      # 5. è¿œç¨‹éƒ¨ç½²
      # -----------------------------------------------------------------
      - name: ğŸš€ è¿œç¨‹åŠ è½½é•œåƒå¹¶é‡å¯
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} " \
            cd ${{ secrets.REMOTE_PROJECT_PATH }} && \
          
            # 1. åŠ è½½é•œåƒ
            echo 'ğŸ³ Loading Docker Image...' && \
            docker load -i sidecar-image.tar.gz && \
          
            # 2. é‡å¯æœåŠ¡
            # æ³¨æ„ï¼šbackend ä¾ç„¶ä½¿ç”¨ build (å®ƒæ˜¯åŸºäº JAR æ„å»º)ï¼Œsidecar ä½¿ç”¨åˆšæ‰ load çš„ image
            docker compose up -d --build backend sync-sidecar && \
          
            # 3. æ¸…ç†
            rm sidecar-image.tar.gz && \
            docker image prune -f \
          "